<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantomsæˆå‘˜åŠ¨æ€</title>
    <style>
        /* æ‰€æœ‰åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #404040;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #707070;
            border-radius: 5px;
            border: 2px solid #404040;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #808080;
        }

        /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
        html {
            scrollbar-width: thin;
            scrollbar-color: #707070 #404040;
        }

        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #404040;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #ffffff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.3rem;
            color: #b0b0b0;
            font-weight: 300;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        select, button {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background-color: #404040;
            color: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            border: 1px solid #555;
        }

        select:hover, button:hover {
            background-color: #505050;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        button {
            background-color: #606060;
            font-weight: 600;
        }

        button:hover {
            background-color: #707070;
        }

        /* è­¦å‘Šä¿¡æ¯æ ·å¼ */
        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            margin-bottom: 25px;
            border-radius: 4px;
            text-align: center;
            display: none;
            font-size: 1rem;
            font-weight: 500;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            border: 1px solid #404040;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .stat-item {
            text-align: center;
            padding: 15px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .stat-label {
            font-size: 1rem;
            color: #b0b0b0;
            margin-top: 5px;
        }

        .activity-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 25px;
        }

        .activity-card {
            background: linear-gradient(145deg, #2a2a2a, #333333);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border: 1px solid #404040;
            position: relative;
            overflow: hidden;
        }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #808080, #a0a0a0);
        }

        .activity-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }

        .activity-header {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }

        .avatar {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 18px;
            border: 3px solid #707070;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .character-info {
            flex: 1;
        }

        .character-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .server-info {
            font-size: 0.95rem;
            color: #b0b0b0;
        }

        .activity-type {
            display: inline-block;
            padding: 5px 12px;
            background-color: #505050;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-top: 8px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .activity-content {
            margin-bottom: 18px;
        }

        .activity-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffffff;
            font-size: 1.2rem;
        }

        .activity-preview {
            font-size: 1rem;
            color: #c0c0c0;
            line-height: 1.5;
            max-height: 72px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .activity-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #a0a0a0;
            border-top: 1px solid #404040;
            padding-top: 15px;
        }

        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .badge {
            background-color: #505050;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #e0e0e0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.3rem;
            color: #b0b0b0;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #d0d0d0;
            font-size: 1.3rem;
        }

        /* é”™è¯¯å®¹å™¨æ ·å¼ */
        .error-container {
            text-align: center;
            padding: 50px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #505050;
            width: 100%;
            margin: 20px 0;
        }

        .error-title {
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #ff6b6b;
            font-weight: 600;
        }

        .error-message {
            color: #b0b0b0;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .reload-button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #606060;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .reload-button:hover {
            background: #707070;
            transform: translateY(-2px);
        }

        .cover-image {
            max-width: 100%;
            margin-top: 15px;
            border-radius: 8px;
            max-height: 220px;
            object-fit: cover;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.85);
        }

        .modal-content {
            background: linear-gradient(145deg, #2a2a2a, #333333);
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 850px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid #505050;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #505050;
            padding-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8rem;
            color: #ffffff;
            font-weight: 600;
        }

        .close {
            color: #b0b0b0;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #ffffff;
            text-decoration: none;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section h3 {
            font-size: 1.3rem;
            color: #ffffff;
            margin-bottom: 12px;
            border-bottom: 1px solid #505050;
            padding-bottom: 8px;
            font-weight: 600;
        }

        .modal-field {
            margin-bottom: 18px;
        }

        .modal-field-value {
            word-break: break-word;
            line-height: 1.6;
            color: #e0e0e0;
        }

        .modal-images {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
        }

        .modal-image {
            max-width: 160px;
            max-height: 160px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .modal-content-text {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
            border: 1px solid #404040;
        }

        /* HTMLå†…å®¹ä¸­çš„å›¾ç‰‡æ ·å¼ */
        .modal-content-text img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 12px 0;
            display: block;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        /* è¡¨æƒ…å›¾ç‰‡ç‰¹æ®Šå¤„ç† */
        .modal-content-text img.emoji {
            max-width: 40px;
            display: inline-block;
            vertical-align: middle;
            margin: 0 4px;
        }

        .modal-character-info {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-character-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 25px;
            border: 4px solid #707070;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-character-details {
            flex: 1;
        }

        .modal-character-name {
            font-size: 1.7rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .modal-character-server {
            font-size: 1.1rem;
            color: #b0b0b0;
        }

        .modal-activity-type {
            display: inline-block;
            padding: 6px 14px;
            background-color: #606060;
            border-radius: 6px;
            font-size: 1rem;
            margin-top: 8px;
            color: #ffffff;
            font-weight: 500;
        }

        /* æ ‡ç­¾æ ·å¼ */
        .label-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .label {
            background-color: #606060;
            color: #ffffff;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* æ»šåŠ¨åŠ è½½ç›¸å…³æ ·å¼ */
        .load-more-container {
            text-align: center;
            padding: 30px;
        }

        .load-more-btn {
            padding: 12px 30px;
            background-color: #606060;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background-color: #707070;
            transform: translateY(-2px);
        }

        .load-more-btn:disabled {
            background-color: #404040;
            cursor: not-allowed;
            transform: none;
        }

        .loading-more {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-more-data {
            color: #b0b0b0;
            font-size: 1rem;
            padding: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .activity-list {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .filter-controls {
                justify-content: center;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }

            .modal-character-info {
                flex-direction: column;
                text-align: center;
            }

            .modal-character-avatar {
                margin-right: 0;
                margin-bottom: 20px;
            }

            /* ç§»åŠ¨ç«¯å›¾ç‰‡æ ·å¼è°ƒæ•´ */
            .modal-content-text img {
                max-width: 100%;
                height: auto;
            }

            h1 {
                font-size: 2.2rem;
            }

            .subtitle {
                font-size: 1.1rem;
            }

            .warning-message {
                font-size: 0.9rem;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Feed & Post</h1>
        <p class="subtitle">Phantoms FC æˆå‘˜æœ€æ–°åŠ¨æ€</p>
    </header>

    <!-- è­¦å‘Šä¿¡æ¯ -->
    <div class="warning-message" id="warningMessage">
        æ­£åœ¨ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®å±•ç¤º
    </div>

    <div class="controls">
        <div class="filter-controls">
            <select id="filter-type">
                <option value="all">å…¨éƒ¨ç±»å‹</option>
                <option value="post">å¸–å­</option>
                <option value="recruit">æ‹›å‹Ÿ</option>
                <option value="rp">RPæ´»åŠ¨</option>
            </select>
            <select id="sort-by">
                <option value="newest">æœ€æ–°å‘å¸ƒ</option>
                <option value="oldest">æœ€æ—©å‘å¸ƒ</option>
                <option value="popular">æœ€å—æ¬¢è¿</option>
            </select>
        </div>
        <button id="refresh-btn">åˆ·æ–°æ•°æ®</button>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="total-count">0</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="post-count">0</div>
            <div class="stat-label">å¸–å­</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="recruit-count">0</div>
            <div class="stat-label">æ‹›å‹Ÿ</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="rp-count">0</div>
            <div class="stat-label">RPæ´»åŠ¨</div>
        </div>
    </div>

    <div id="activity-container">
        <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    </div>

    <!-- æ»šåŠ¨åŠ è½½æ›´å¤šåŒºåŸŸ -->
    <div id="load-more-container" class="load-more-container" style="display: none;">
        <button id="load-more-btn" class="load-more-btn">
            <span class="loading-more" style="display: none;"></span>
            åŠ è½½æ›´å¤š
        </button>
        <div id="no-more-data" class="no-more-data" style="display: none;">æ²¡æœ‰æ›´å¤šæ•°æ®äº†</div>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">åŠ¨æ€è¯¦æƒ…</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- åŠ¨æ€è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
        </div>
    </div>
</div>

<script>
    // APIç«¯ç‚¹
    const API_URL = 'https://phantoms-backend.onrender.com/api/risingstones/guild-member-dynamic';

    // æœ¬åœ°æ•°æ®æºè·¯å¾„
    const LOCAL_DATA_SOURCE = './sample/guild-member-dynamic-modified.json';

    // å›¾ç‰‡ä»£ç†æœåŠ¡ - ä½¿ç”¨images.weserv.nl
    const IMAGE_PROXY_URL = 'https://images.weserv.nl/?url=';

    // é»˜è®¤å¤´åƒ
    const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiMyNjJmNDkiLz4KPHN2ZyB4PSIxNSIgeT0iMTUiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNlOTQ1NjAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPHBhdGggZD0iTTIwIDIxdi0yYTQgNCAwIDAgMC00LTRINGE0IDQgMCAwIDAtNCA0djIiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ii8+Cjwvc3ZnPgo8L3N2Zz4K';

    // å…¨å±€å˜é‡å­˜å‚¨æ•°æ®
    let activitiesData = [];
    let filteredData = [];

    // åˆ†é¡µç›¸å…³å˜é‡
    let currentPage = 1;
    let hasMoreData = true;
    let isLoading = false;
    let currentFilterType = 'all';
    let currentSortBy = 'newest';
    let isUsingLocalData = false; // æ ‡è®°æ˜¯å¦åœ¨ä½¿ç”¨æœ¬åœ°æ•°æ®

    // è¶…æ—¶ç›¸å…³å˜é‡
    const REQUEST_TIMEOUT = 10000; // 10ç§’è¶…æ—¶
    let requestTimeoutId = null;

    // é¡µé¢åŠ è½½å®Œæˆåè·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŠ è½½ç¬¬ä¸€é¡µæ•°æ®
        fetchData(1, true);

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('filter-type').addEventListener('change', function() {
            currentFilterType = this.value;
            currentPage = 1;
            hasMoreData = true;
            filterAndSortActivities(true);
        });

        document.getElementById('sort-by').addEventListener('change', function() {
            currentSortBy = this.value;
            currentPage = 1;
            hasMoreData = true;
            filterAndSortActivities(true);
        });

        document.getElementById('refresh-btn').addEventListener('click', function() {
            currentPage = 1;
            hasMoreData = true;
            isUsingLocalData = false;
            hideWarningMessage();
            fetchData(1, true);
        });

        // åŠ è½½æ›´å¤šæŒ‰é’®äº‹ä»¶
        document.getElementById('load-more-btn').addEventListener('click', function() {
            if (!isLoading && hasMoreData) {
                if (isUsingLocalData) {
                    // ä½¿ç”¨æœ¬åœ°æ•°æ®æ—¶ï¼ŒåŠ è½½æ›´å¤šåŠŸèƒ½ä½¿ç”¨å®¢æˆ·ç«¯åˆ†é¡µ
                    loadMoreLocalData();
                } else {
                    fetchData(currentPage + 1, false);
                }
            }
        });

        // å¼¹çª—å…³é—­äº‹ä»¶
        document.querySelector('.close').addEventListener('click', closeModal);
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // æ»šåŠ¨åŠ è½½ç›‘å¬
        window.addEventListener('scroll', handleScroll);
    });

    // æ»šåŠ¨åŠ è½½å¤„ç†
    function handleScroll() {
        // å¦‚æœæ­£åœ¨åŠ è½½æˆ–æ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œåˆ™ä¸å¤„ç†
        if (isLoading || !hasMoreData) return;

        const loadMoreBtn = document.getElementById('load-more-btn');
        if (!loadMoreBtn || loadMoreBtn.style.display === 'none') {
            return;
        }

        // è®¡ç®—è·ç¦»åº•éƒ¨çš„è·ç¦»
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;

        // å½“æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨200pxä»¥å†…æ—¶ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤š
        if (scrollTop + windowHeight >= documentHeight - 200) {
            if (isUsingLocalData) {
                loadMoreLocalData();
            } else {
                fetchData(currentPage + 1, false);
            }
        }
    }

    // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
    function showWarningMessage() {
        const warningElement = document.getElementById('warningMessage');
        warningElement.style.display = 'block';
        isUsingLocalData = true;
    }

    // éšè—è­¦å‘Šä¿¡æ¯
    function hideWarningMessage() {
        const warningElement = document.getElementById('warningMessage');
        warningElement.style.display = 'none';
        isUsingLocalData = false;
    }

    // ä»æœ¬åœ°JSONæ–‡ä»¶åŠ è½½æ•°æ®
    async function loadLocalData() {
        try {
            const response = await fetch(LOCAL_DATA_SOURCE);
            if (!response.ok) {
                throw new Error('Failed to load local data');
            }
            const data = await response.json();

            // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
            showWarningMessage();

            // å¦‚æœæœ¬åœ°æ•°æ®æ ¼å¼å’ŒAPIè¿”å›æ ¼å¼ä¸€è‡´
            if (data.code === 10000 && data.data) {
                return {
                    code: 10000,
                    data: data.data
                };
            } else if (data.data && data.data.rows) {
                // å¦‚æœæœ¬åœ°æ•°æ®å·²ç»æ˜¯ç›´æ¥çš„æ•°æ®æ ¼å¼
                return {
                    code: 10000,
                    data: data.data
                };
            } else if (data.rows) {
                // å¦‚æœæ˜¯åŸå§‹çš„rowsæ•°ç»„æ ¼å¼
                return {
                    code: 10000,
                    data: {
                        rows: data.rows,
                        count: data.count || data.rows.length
                    }
                };
            } else {
                throw new Error('Invalid local data format');
            }
        } catch (error) {
            console.error('Failed to load local data:', error);
            return null;
        }
    }

    // æœ¬åœ°æ•°æ®åˆ†é¡µï¼ˆå®¢æˆ·ç«¯åˆ†é¡µï¼‰
    async function loadMoreLocalData() {
        try {
            // åŠ è½½æœ¬åœ°æ•°æ®
            const localData = await loadLocalData();
            if (!localData) {
                throw new Error('æ— æ³•åŠ è½½æœ¬åœ°æ•°æ®');
            }

            const allActivities = localData.data.rows;
            const itemsPerPage = 10;

            // è®¡ç®—è¦æ˜¾ç¤ºçš„ä¸‹ä¸€é¡µæ•°æ®
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            const newActivities = allActivities.slice(startIndex, endIndex);

            if (newActivities.length === 0) {
                hasMoreData = false;
                showNoMoreData();
                return;
            }

            // å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼Œæ›¿æ¢æ‰€æœ‰æ•°æ®ï¼Œå¦åˆ™è¿½åŠ æ•°æ®
            if (currentPage === 1) {
                activitiesData = newActivities;
            } else {
                activitiesData = [...activitiesData, ...newActivities];
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats({
                code: 10000,
                data: {
                    count: allActivities.length
                }
            });

            // è¿‡æ»¤å’Œæ’åºæ•°æ®
            filterAndSortActivities(currentPage === 1);

            // æ›´æ–°åˆ†é¡µçŠ¶æ€
            if (endIndex >= allActivities.length) {
                hasMoreData = false;
                showNoMoreData();
            } else {
                currentPage++;
                hasMoreData = true;
                showLoadMoreButton();
            }

        } catch (error) {
            console.error('Error loading more local data:', error);
            showLoadMoreError('åŠ è½½æ•°æ®å¤±è´¥', error.message);
        }
    }

    // è·å–æ•°æ®å‡½æ•°
    async function fetchData(page = 1, isRefresh = true) {
        // é˜²æ­¢é‡å¤è¯·æ±‚
        if (isLoading) return;

        isLoading = true;

        // è®¾ç½®è¶…æ—¶å®šæ—¶å™¨
        if (requestTimeoutId) {
            clearTimeout(requestTimeoutId);
        }

        requestTimeoutId = setTimeout(() => {
            handleRequestTimeout(isRefresh);
        }, REQUEST_TIMEOUT);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (isRefresh) {
            const container = document.getElementById('activity-container');
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>';
            hideLoadMoreButton();
        } else {
            // åªæœ‰åœ¨æœ‰åŠ è½½æ›´å¤šæŒ‰é’®æ—¶æ‰æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn && loadMoreBtn.style.display !== 'none') {
                showLoadingMore();
            }
        }

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

            const response = await fetch(`${API_URL}?page=${page}&limit=10`, {
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            clearTimeout(requestTimeoutId);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            // æ·»åŠ å¯¹code 500çš„å¤„ç†
            if (data.code === 500) {
                throw new Error(data.message || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
            }

            if (data.code === 10000) {
                // APIè¯·æ±‚æˆåŠŸï¼Œéšè—è­¦å‘Šä¿¡æ¯
                hideWarningMessage();
                isUsingLocalData = false;

                const newActivities = data.data.rows;

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
                if (newActivities.length === 0) {
                    hasMoreData = false;
                    showNoMoreData();
                } else {
                    currentPage = page;

                    if (isRefresh) {
                        // åˆ·æ–°æ—¶æ›¿æ¢æ‰€æœ‰æ•°æ®
                        activitiesData = newActivities;
                        updateStats(data);
                        filterAndSortActivities(true);
                    } else {
                        // åŠ è½½æ›´å¤šæ—¶è¿½åŠ æ•°æ®
                        activitiesData = [...activitiesData, ...newActivities];
                        updateStats(data);
                        filterAndSortActivities(false);
                    }

                    hasMoreData = true;
                }
            } else {
                throw new Error(`API error: ${data.msg}`);
            }
        } catch (error) {
            clearTimeout(requestTimeoutId);
            console.error('APIè¯·æ±‚å¤±è´¥ï¼Œå°è¯•åŠ è½½æœ¬åœ°æ•°æ®:', error);

            // APIè¯·æ±‚å¤±è´¥ï¼Œå°è¯•åŠ è½½æœ¬åœ°æ•°æ®
            const localData = await loadLocalData();

            if (localData) {
                // æœ¬åœ°æ•°æ®åŠ è½½æˆåŠŸ
                const newActivities = localData.data.rows;

                if (isRefresh) {
                    // åˆ·æ–°æ—¶ä½¿ç”¨æœ¬åœ°æ•°æ®
                    activitiesData = newActivities;
                    updateStats(localData);
                    filterAndSortActivities(true);

                    // å¯¹äºæœ¬åœ°æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®åˆ†é¡µ
                    currentPage = 1;
                    hasMoreData = newActivities.length > 10;
                } else {
                    // å¯¹äºåŠ è½½æ›´å¤šï¼Œæˆ‘ä»¬éœ€è¦å®ç°å®¢æˆ·ç«¯åˆ†é¡µ
                    await loadMoreLocalData();
                }
            } else {
                // æœ¬åœ°æ•°æ®ä¹ŸåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
                if (isRefresh) {
                    const container = document.getElementById('activity-container');
                    let errorMessage = 'åŠ è½½æ•°æ®å¤±è´¥';
                    let errorDetail = error.message;

                    if (error.message.includes('Failed to get guild member dynamic info')) {
                        errorMessage = 'çŸ³ä¹‹å®¶åŠŸèƒ½ç»´æŠ¤ä¸­';
                        errorDetail = 'è¯·ç¨åå†è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜';
                    } else if (error.name === 'AbortError' || error.message.includes('timeout')) {
                        errorMessage = 'çŸ³ä¹‹å®¶åŠŸèƒ½ç»´æŠ¤ä¸­';
                        errorDetail = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åå†è¯•';
                    } else if (error.message.includes('æœåŠ¡å™¨è¿”å›é”™è¯¯')) {
                        errorMessage = 'çŸ³ä¹‹å®¶åŠŸèƒ½ç»´æŠ¤ä¸­';
                        errorDetail = error.message || 'è¯·ç¨åå†è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜';
                    }

                    container.innerHTML = `
                        <div class="error-container">
                            <div class="error-title">${errorMessage}</div>
                            <div class="error-message">${errorDetail}</div>
                            <button onclick="location.reload()" class="reload-button">
                                é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                } else {
                    // å¯¹äºåŠ è½½æ›´å¤šçš„æƒ…å†µï¼Œæ˜¾ç¤ºä¸´æ—¶é”™è¯¯æç¤º
                    showLoadMoreError('åŠ è½½æ•°æ®å¤±è´¥', error.message);
                }
                hasMoreData = false;
                showNoMoreData();
            }
        } finally {
            isLoading = false;
            hideLoadingMore();

            // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
            if (requestTimeoutId) {
                clearTimeout(requestTimeoutId);
                requestTimeoutId = null;
            }

            // åªæœ‰åœ¨æœ‰æ›´å¤šæ•°æ®ä¸”ä¸æ˜¯åˆ·æ–°æ“ä½œæ—¶æ‰æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
            if (hasMoreData && !isRefresh) {
                showLoadMoreButton();
            }
        }
    }

    // æ·»åŠ åŠ è½½æ›´å¤šæ—¶çš„é”™è¯¯æ˜¾ç¤ºå‡½æ•°
    function showLoadMoreError(errorMessage, errorDetail) {
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„é”™è¯¯æç¤ºå…ƒç´ 
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-container';
        errorDiv.innerHTML = `
            <div class="error-title">${errorMessage}</div>
            <div class="error-message">${errorDetail}</div>
        `;

        // å°†é”™è¯¯æç¤ºæ’å…¥åˆ°æ´»åŠ¨åˆ—è¡¨åé¢
        const container = document.getElementById('activity-container');
        container.parentNode.insertBefore(errorDiv, container.nextSibling);

        // 5ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æç¤º
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    // è¶…æ—¶å¤„ç†å‡½æ•°
    function handleRequestTimeout(isRefresh) {
        if (isLoading) {
            isLoading = false;
            hideLoadingMore();

            if (isRefresh) {
                const container = document.getElementById('activity-container');
                container.innerHTML = `
                    <div class="error-container">
                        <div class="error-title">çŸ³ä¹‹å®¶åŠŸèƒ½ç»´æŠ¤ä¸­</div>
                        <div class="error-message">è¯·æ±‚è¶…æ—¶ï¼Œå°è¯•åŠ è½½æœ¬åœ°æ•°æ®...</div>
                        <button onclick="location.reload()" class="reload-button">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
            } else {
                showLoadMoreError('çŸ³ä¹‹å®¶åŠŸèƒ½ç»´æŠ¤ä¸­', 'è¯·æ±‚è¶…æ—¶ï¼Œå°è¯•åŠ è½½æœ¬åœ°æ•°æ®...');
            }
        }
    }

    // ä»¥ä¸‹æ‰€æœ‰å…¶ä»–å‡½æ•°ä¿æŒä¸å˜ï¼ˆupdateStats, filterAndSortActivities, displayActivities,
    // createActivityCard, openModal, closeModal ç­‰ï¼‰
    // ç”±äºä»£ç é•¿åº¦é™åˆ¶ï¼Œè¿™é‡Œåªåˆ—å‡ºéœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œå®Œæ•´å‡½æ•°è¯·å‚è€ƒåŸæ–‡ä»¶
    // æ³¨æ„ï¼šä»¥ä¸‹å‡½æ•°éœ€è¦ä¿æŒä¸åŸæ–‡å®Œå…¨ä¸€è‡´

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(data) {
        // ä½¿ç”¨APIè¿”å›çš„countä½œä¸ºTotalå€¼ï¼Œæ·»åŠ å®‰å…¨æ£€æŸ¥
        let totalCount = 0;
        if (data && data.data && data.data.count) {
            totalCount = parseInt(data.data.count);
        } else {
            totalCount = activitiesData.length;
        }
        document.getElementById('total-count').textContent = totalCount;

        // å…¶ä»–ç»Ÿè®¡ä¿æŒä¸å˜
        const postCount = activitiesData.filter(activity => activity.from === 2).length;
        const recruitCount = activitiesData.filter(activity =>
            activity.from === 5 || activity.from === 6 || activity.from === 9 || activity.from === 7).length;
        const rpCount = activitiesData.filter(activity => activity.from === 8).length;

        document.getElementById('post-count').textContent = postCount;
        document.getElementById('recruit-count').textContent = recruitCount;
        document.getElementById('rp-count').textContent = rpCount;
    }

    // è¿‡æ»¤å’Œæ’åºæ´»åŠ¨
    function filterAndSortActivities(resetPagination = true) {
        if (resetPagination) {
            currentPage = 1;
            hasMoreData = true;
        }

        // è¿‡æ»¤æ•°æ®
        if (currentFilterType === 'all') {
            filteredData = [...activitiesData];
        } else if (currentFilterType === 'post') {
            filteredData = activitiesData.filter(activity => activity.from === 2);
        } else if (currentFilterType === 'recruit') {
            filteredData = activitiesData.filter(activity =>
                activity.from === 5 || activity.from === 6 || activity.from === 9 || activity.from === 7);
        } else if (currentFilterType === 'rp') {
            filteredData = activitiesData.filter(activity => activity.from === 8);
        }

        // æ’åºæ•°æ®
        if (currentSortBy === 'newest') {
            filteredData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (currentSortBy === 'oldest') {
            filteredData.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        } else if (currentSortBy === 'popular') {
            filteredData.sort((a, b) => {
                const aLikes = parseInt(a.like_count) || 0;
                const bLikes = parseInt(b.like_count) || 0;
                return bLikes - aLikes;
            });
        }

        displayActivities();
    }

    // æ˜¾ç¤ºæ´»åŠ¨
    function displayActivities() {
        const container = document.getElementById('activity-container');

        if (filteredData.length === 0) {
            container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ´»åŠ¨</div>';
            hideLoadMoreButton();
            return;
        }

        container.innerHTML = '<div class="activity-list"></div>';
        const activityList = container.querySelector('.activity-list');

        filteredData.forEach(activity => {
            const activityCard = createActivityCard(activity);
            activityList.appendChild(activityCard);
        });

        // å¦‚æœæœ‰æ›´å¤šæ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
        if (hasMoreData) {
            showLoadMoreButton();
        } else {
            showNoMoreData();
        }
    }

    // åˆ›å»ºæ´»åŠ¨å¡ç‰‡ï¼ˆéœ€è¦ä»åŸæ–‡ä»¶å¤åˆ¶å®Œæ•´å®ç°ï¼‰
    function createActivityCard(activity) {
        // å¤åˆ¶åŸæ–‡ä»¶çš„å®Œæ•´å®ç°...
        const card = document.createElement('div');
        card.className = 'activity-card';
        card.dataset.activity = JSON.stringify(activity);

        // è§£æå¾½ç« æ•°æ®
        let badges = [];
        try {
            if (activity.badge && activity.badge !== '[]') {
                badges = JSON.parse(activity.badge);
            }
        } catch (e) {
            console.error('Error parsing badges:', e);
            badges = [];
        }

        // è·å–æ´»åŠ¨ç±»å‹å’Œå†…å®¹
        const { typeText, title, content, coverImage } = getActivityDetails(activity);

        // ä½¿ç”¨ä»£ç†å¤„ç†å›¾ç‰‡URL
        const avatarUrl = activity.avatar ? getProxiedImageUrl(activity.avatar) : DEFAULT_AVATAR;
        const coverUrl = coverImage ? getProxiedImageUrl(coverImage) : null;

        card.innerHTML = `
            <div class="activity-header">
                <img src="${avatarUrl}" alt="å¤´åƒ" class="avatar" onerror="this.src='${DEFAULT_AVATAR}'">
                <div class="character-info">
                    <div class="character-name">${activity.character_name}</div>
                    <div class="server-info">${activity.area_name} Â· ${activity.group_name}</div>
                    <span class="activity-type">${typeText}</span>
                </div>
            </div>

            <div class="activity-content">
                <div class="activity-title">${title || 'æ— æ ‡é¢˜'}</div>
                <div class="activity-preview">${content}</div>
                ${coverUrl ? `<img src="${coverUrl}" class="cover-image" alt="å°é¢" onerror="this.style.display='none'">` : ''}
            </div>

            ${badges.length > 0 ? `
            <div class="badges">
                ${badges.slice(0, 3).map(badge =>
            `<span class="badge">${badge.badgeName}</span>`
        ).join('')}
                ${badges.length > 3 ? `<span class="badge">+${badges.length - 3}æ›´å¤š</span>` : ''}
            </div>
            ` : ''}

            <div class="activity-meta">
                <div>${formatDate(activity.created_at)}</div>
                <div>â¤ï¸ ${activity.like_count} Â· ğŸ’¬ ${activity.comment_count}</div>
            </div>
        `;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ‰“å¼€å¼¹çª—
        card.addEventListener('click', function() {
            openModal(activity);
        });

        return card;
    }

    // æ‰“å¼€å¼¹çª—æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆéœ€è¦ä»åŸæ–‡ä»¶å¤åˆ¶å®Œæ•´å®ç°ï¼‰
    function openModal(activity) {
        const modal = document.getElementById('detailModal');
        const modalBody = document.getElementById('modalBody');

        // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
        modalBody.innerHTML = '';

        // åˆ›å»ºè§’è‰²ä¿¡æ¯éƒ¨åˆ†
        const characterInfoSection = createCharacterInfoSection(activity);
        modalBody.appendChild(characterInfoSection);

        // åˆ›å»ºæ´»åŠ¨å†…å®¹éƒ¨åˆ†
        const contentSection = createContentSection(activity);
        modalBody.appendChild(contentSection);

        // å¦‚æœæœ‰é¢å¤–ä¿¡æ¯ï¼Œåˆ›å»ºè¯¦ç»†ä¿¡æ¯éƒ¨åˆ†
        const detailSection = createDetailSection(activity);
        if (detailSection) {
            modalBody.appendChild(detailSection);
        }

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'block';
    }

    // å…³é—­å¼¹çª—
    function closeModal() {
        const modal = document.getElementById('detailModal');
        modal.style.display = 'none';
    }

    // è·å–ä»£ç†å›¾ç‰‡URL
    function getProxiedImageUrl(originalUrl) {
        // å¦‚æœå·²ç»æ˜¯ä»£ç†URLï¼Œç›´æ¥è¿”å›
        if (originalUrl.includes('weserv.nl')) {
            return originalUrl;
        }

        // ä½¿ç”¨images.weserv.nlä»£ç†æœåŠ¡
        return `${IMAGE_PROXY_URL}${encodeURIComponent(originalUrl)}`;
    }

    // ä»¥ä¸‹æ‰€æœ‰è¾…åŠ©å‡½æ•°éƒ½éœ€è¦ä»åŸæ–‡ä»¶å®Œæ•´å¤åˆ¶
    // åŒ…æ‹¬ï¼šcreateCharacterInfoSection, createContentSection, createDetailSection,
    // convertEmojiTags, processHtmlImages, processImagesInElement,
    // getActivityDetails, formatDate, formatFullDate,
    // showLoadMoreButton, hideLoadMoreButton, showLoadingMore,
    // hideLoadingMore, showNoMoreData

    // è¡¨æƒ…æ ‡è®°è½¬æ¢å‡½æ•°
    function convertEmojiTags(text) {
        if (!text) return text;

        // å°†è¡¨æƒ…æ ‡è®° [emo19] è½¬æ¢ä¸ºå›¾ç‰‡æ ‡ç­¾
        // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… [emoæ•°å­—] æ ¼å¼
        return text.replace(/\[emo(\d+)\]/g, function(match, emojiId) {
            // æ„å»ºè¡¨æƒ…å›¾ç‰‡URL
            const emojiUrl = `https://static.web.sdo.com/jijiamobile/pic/ff14/2023ffstone/emo${emojiId}.png`;
            // ä½¿ç”¨ä»£ç†URL
            const proxiedUrl = getProxiedImageUrl(emojiUrl);

            // è¿”å›å›¾ç‰‡æ ‡ç­¾ï¼Œè®¾ç½®åˆé€‚çš„å¤§å°
            return `<img src="${proxiedUrl}" alt="è¡¨æƒ…${emojiId}" class="emoji" onerror="this.style.display='none'">`;
        });
    }

    // è·å–æ´»åŠ¨è¯¦æƒ…
    function getActivityDetails(activity) {
        let typeText = 'æœªçŸ¥';
        let title = '';
        let content = '';
        let coverImage = '';

        // æ ¹æ®fromå­—æ®µåˆ¤æ–­æ´»åŠ¨ç±»å‹
        switch(activity.from) {
            case 1: // æ™®é€šåŠ¨æ€
                typeText = 'å‘å¸ƒäº†åŠ¨æ€';
                // ç§»é™¤è¡¨æƒ…æ ‡è®°ç”¨äºé¢„è§ˆ
                content = activity.mask_content ?
                    activity.mask_content.replace(/\[emo\d+\]/g, '[è¡¨æƒ…]') : '';
                coverImage = activity.pic_url || '';
                break;
            case 2: // å¸–å­
                typeText = 'å‘è¡¨äº†å¸–å­';
                if (activity.from_info) {
                    title = activity.from_info.title;
                    content = activity.from_info.content_pre || '';
                    coverImage = activity.from_info.cover_pic || '';
                }
                break;
            case 5: // å¯¼å¸ˆæ‹›å‹Ÿ
                typeText = 'å‘å¸ƒäº†å¯¼å¸ˆæ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = activity.from_info.title;
                    content = activity.from_info.detail_mask ?
                        activity.from_info.detail_mask.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : '';
                }
                break;
            case 6: // å‰¯æœ¬æ‹›å‹Ÿ
                typeText = 'å‘å¸ƒäº†å‰¯æœ¬æ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = activity.from_info.fb_name;
                    content = activity.from_info.progress || '';
                }
                break;
            case 7: // åˆ†äº«æ‹›å‹Ÿ
                typeText = 'åˆ†äº«äº†æ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = (activity.from_info.guild_name || '') + (activity.from_info.guild_tag ? ` <${activity.from_info.guild_tag}>` : '');
                    content = activity.from_info.detail_mask ?
                        activity.from_info.detail_mask.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : '';
                    coverImage = activity.from_info.cover_pic || '';
                }
                break;
            case 8: // RPæ´»åŠ¨
                typeText = 'å‘å¸ƒäº†RPæ´»åŠ¨';
                if (activity.from_info) {
                    title = activity.from_info.rp_name;
                    content = activity.from_info.profile || '';
                    coverImage = activity.from_info.cover_pic || '';
                }
                break;
            case 9: // å…¶ä»–æ‹›å‹Ÿ
                typeText = 'å‘å¸ƒäº†æ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = activity.from_info.title;
                    content = activity.from_info.detail_mask ?
                        activity.from_info.detail_mask.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : '';
                }
                break;
            default:
                typeText = activity.mask_content || 'å‘å¸ƒäº†å†…å®¹';
        }

        // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨mask_contentï¼ˆä½†éœ€è¦è¿‡æ»¤æ‰æ— æ„ä¹‰çš„é»˜è®¤æ–‡æœ¬ï¼‰
        if (!content && activity.mask_content) {
            const meaninglessTexts = ['å‘è¡¨äº†å¸–å­ï¼š', 'å‘å¸ƒäº†æ‹›å‹Ÿï¼š', 'å‘å¸ƒäº†RPï¼š', 'ä¸Šæ¶äº†æ‹›å‹Ÿï¼š', 'åˆ†äº«æ‹›å‹Ÿ-'];
            const isMeaningless = meaninglessTexts.some(text => activity.mask_content.includes(text));

            if (!isMeaningless) {
                content = activity.mask_content;
            }
        }

        // å¤„ç†HTMLæ ‡ç­¾ï¼Œæå–çº¯æ–‡æœ¬ç”¨äºé¢„è§ˆ
        if (content && content.includes('<')) {
            content = content.replace(/<[^>]*>/g, '');
        }

        // é™åˆ¶å†…å®¹é•¿åº¦
        if (content && content.length > 100) {
            content = content.substring(0, 100) + '...';
        }

        return { typeText, title, content, coverImage };
    }

    // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 1) {
            return 'åˆšåˆš';
        } else if (diffMins < 60) {
            return `${diffMins}åˆ†é’Ÿå‰`;
        } else if (diffHours < 24) {
            return `${diffHours}å°æ—¶å‰`;
        } else if (diffDays < 7) {
            return `${diffDays}å¤©å‰`;
        } else {
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    }

    // å®Œæ•´æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
    function formatFullDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
    function showLoadMoreButton() {
        const container = document.getElementById('load-more-container');
        const button = document.getElementById('load-more-btn');
        const noMoreData = document.getElementById('no-more-data');

        container.style.display = 'block';
        button.style.display = 'inline-block';
        noMoreData.style.display = 'none';
    }

    // éšè—åŠ è½½æ›´å¤šæŒ‰é’®
    function hideLoadMoreButton() {
        const container = document.getElementById('load-more-container');
        container.style.display = 'none';
    }

    // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
    function showLoadingMore() {
        const button = document.getElementById('load-more-btn');
        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨ä¸”å¯è§
        if (!button || button.style.display === 'none') {
            return; // å¦‚æœæŒ‰é’®ä¸å­˜åœ¨æˆ–éšè—ï¼Œç›´æ¥è¿”å›
        }

        const loadingIcon = button.querySelector('.loading-more');

        button.disabled = true;
        if (loadingIcon) {
            loadingIcon.style.display = 'inline-block';
        }
        button.innerHTML = '<span class="loading-more"></span> åŠ è½½ä¸­...';
    }

    // éšè—åŠ è½½ä¸­çŠ¶æ€
    function hideLoadingMore() {
        const button = document.getElementById('load-more-btn');
        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
        if (!button) {
            return;
        }

        button.disabled = false;
        button.innerHTML = 'åŠ è½½æ›´å¤š';
    }

    // æ˜¾ç¤ºæ²¡æœ‰æ›´å¤šæ•°æ®
    function showNoMoreData() {
        const container = document.getElementById('load-more-container');
        const button = document.getElementById('load-more-btn');
        const noMoreData = document.getElementById('no-more-data');

        container.style.display = 'block';
        button.style.display = 'none';
        noMoreData.style.display = 'block';
    }
</script>

<!-- å¼•å…¥è®¿å®¢ç»Ÿè®¡æ¨¡å— -->
<script src="../visitor-tracker.js"></script>
<!-- Cloudflare Web Analytics -->
<script defer src='../lib/cloudflare/beacon.min.js' data-cf-beacon='{"token": "0e55e488041949479a3dace73ef940cd"}'>
</script>
<!-- End Cloudflare Web Analytics -->

</body>
</html>