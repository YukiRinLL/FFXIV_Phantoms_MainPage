<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 éƒ¨é˜Ÿæˆå‘˜åŠ¨æ€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #0f3460;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #e94560;
            border-radius: 6px;
            border: 2px solid #0f3460;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #d63447;
        }

        /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
        html {
            scrollbar-width: thin;
            scrollbar-color: #e94560 #0f3460;
        }

        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            line-height: 1.6;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #e94560;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #a9a9a9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        select, button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #0f3460;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, button:hover {
            background-color: #16213e;
            transform: translateY(-2px);
        }

        button {
            background-color: #e94560;
        }

        button:hover {
            background-color: #d63447;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background-color: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #e94560;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #a9a9a9;
        }

        .activity-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .activity-card {
            background-color: #16213e;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .activity-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #e94560;
        }

        .character-info {
            flex: 1;
        }

        .character-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e94560;
        }

        .server-info {
            font-size: 0.9rem;
            color: #a9a9a9;
        }

        .activity-type {
            display: inline-block;
            padding: 3px 8px;
            background-color: #0f3460;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .activity-content {
            margin-bottom: 15px;
        }

        .activity-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .activity-preview {
            font-size: 0.9rem;
            color: #b8b8b8;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .activity-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
            border-top: 1px solid #2d3746;
            padding-top: 10px;
        }

        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .badge {
            background-color: #0f3460;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e94560;
            font-size: 1.2rem;
        }

        .cover-image {
            max-width: 100%;
            margin-top: 10px;
            border-radius: 5px;
            max-height: 200px;
            object-fit: cover;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #16213e;
            margin: 2% auto;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #2d3746;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #e94560;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #e94560;
            text-decoration: none;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .modal-section {
            margin-bottom: 15px;
        }

        .modal-section h3 {
            font-size: 1.1rem;
            color: #e94560;
            margin-bottom: 8px;
            border-bottom: 1px solid #2d3746;
            padding-bottom: 5px;
        }

        .modal-field {
            margin-bottom: 15px;
        }

        .modal-field-value {
            word-break: break-word;
            line-height: 1.5;
        }

        .modal-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .modal-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 5px;
            object-fit: cover;
        }

        .modal-content-text {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        /* HTMLå†…å®¹ä¸­çš„å›¾ç‰‡æ ·å¼ */
        .modal-content-text img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin: 10px 0;
            display: block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* è¡¨æƒ…å›¾ç‰‡ç‰¹æ®Šå¤„ç† */
        .modal-content-text img[width="40"],
        .modal-content-text img[height="auto"] {
            max-width: 40px;
            display: inline-block;
            vertical-align: middle;
            margin: 0 2px;
        }

        .modal-character-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-character-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
            border: 3px solid #e94560;
        }

        .modal-character-details {
            flex: 1;
        }

        .modal-character-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e94560;
            margin-bottom: 5px;
        }

        .modal-character-server {
            font-size: 1rem;
            color: #a9a9a9;
        }

        .modal-activity-type {
            display: inline-block;
            padding: 5px 10px;
            background-color: #e94560;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* æ ‡ç­¾æ ·å¼ */
        .label-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .label {
            background-color: #e94560;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .activity-list {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .filter-controls {
                justify-content: center;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }

            .modal-character-info {
                flex-direction: column;
                text-align: center;
            }

            .modal-character-avatar {
                margin-right: 0;
                margin-bottom: 15px;
            }

            /* ç§»åŠ¨ç«¯å›¾ç‰‡æ ·å¼è°ƒæ•´ */
            .modal-content-text img {
                max-width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>FF14 éƒ¨é˜Ÿæˆå‘˜åŠ¨æ€</h1>
        <p class="subtitle">æ‹‚æ™“ä¹‹é—´ - Phantom éƒ¨é˜Ÿæˆå‘˜æœ€æ–°æ´»åŠ¨</p>
    </header>

    <div class="controls">
        <div class="filter-controls">
            <select id="filter-type">
                <option value="all">å…¨éƒ¨ç±»å‹</option>
                <option value="post">å¸–å­</option>
                <option value="recruit">æ‹›å‹Ÿ</option>
                <option value="rp">RPæ´»åŠ¨</option>
            </select>
            <select id="sort-by">
                <option value="newest">æœ€æ–°å‘å¸ƒ</option>
                <option value="oldest">æœ€æ—©å‘å¸ƒ</option>
                <option value="popular">æœ€å—æ¬¢è¿</option>
            </select>
        </div>
        <button id="refresh-btn">åˆ·æ–°æ•°æ®</button>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="total-count">0</div>
            <div class="stat-label">æ€»åŠ¨æ€æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="post-count">0</div>
            <div class="stat-label">å¸–å­æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="recruit-count">0</div>
            <div class="stat-label">æ‹›å‹Ÿæ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="rp-count">0</div>
            <div class="stat-label">RPæ´»åŠ¨æ•°</div>
        </div>
    </div>

    <div id="activity-container">
        <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    </div>
</div>

<!-- å¼¹çª— -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">åŠ¨æ€è¯¦æƒ…</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- åŠ¨æ€è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
        </div>
    </div>
</div>

<script>
    // APIç«¯ç‚¹
    const API_URL = 'https://phantoms-backend.onrender.com/api/risingstones/guild-member-dynamic';

    // å›¾ç‰‡ä»£ç†æœåŠ¡ - ä½¿ç”¨images.weserv.nl
    const IMAGE_PROXY_URL = 'https://images.weserv.nl/?url=';

    // é»˜è®¤å¤´åƒ
    const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiByeD0iMzAiIGZpbGw9IiMyNjJmNDkiLz4KPHN2ZyB4PSIxNSIgeT0iMTUiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNlOTQ1NjAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj4KPHBhdGggZD0iTTIwIDIxdi0yYTQgNCAwIDAgMC00LTRINGE0IDQgMCAwIDAtNCA0djIiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ii8+Cjwvc3ZnPgo8L3N2Zz4K';

    // å…¨å±€å˜é‡å­˜å‚¨æ•°æ®
    let activitiesData = [];
    let filteredData = [];

    // é¡µé¢åŠ è½½å®Œæˆåè·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        fetchData();

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('filter-type').addEventListener('change', filterActivities);
        document.getElementById('sort-by').addEventListener('change', sortActivities);
        document.getElementById('refresh-btn').addEventListener('click', fetchData);

        // å¼¹çª—å…³é—­äº‹ä»¶
        document.querySelector('.close').addEventListener('click', closeModal);
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    });

    // è·å–æ•°æ®å‡½æ•°
    async function fetchData() {
        const container = document.getElementById('activity-container');
        container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>';

        try {
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (data.code === 10000) {
                activitiesData = data.data.rows;
                updateStats();
                filterActivities();
            } else {
                throw new Error(`API error: ${data.msg}`);
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            container.innerHTML = `<div class="error">åŠ è½½æ•°æ®å¤±è´¥: ${error.message}</div>`;
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
        document.getElementById('total-count').textContent = activitiesData.length;

        const postCount = activitiesData.filter(activity => activity.from === 2).length;
        const recruitCount = activitiesData.filter(activity =>
            activity.from === 5 || activity.from === 6 || activity.from === 9).length;
        const rpCount = activitiesData.filter(activity => activity.from === 8).length;

        document.getElementById('post-count').textContent = postCount;
        document.getElementById('recruit-count').textContent = recruitCount;
        document.getElementById('rp-count').textContent = rpCount;
    }

    // è¿‡æ»¤æ´»åŠ¨
    function filterActivities() {
        const filterType = document.getElementById('filter-type').value;

        if (filterType === 'all') {
            filteredData = [...activitiesData];
        } else if (filterType === 'post') {
            filteredData = activitiesData.filter(activity => activity.from === 2);
        } else if (filterType === 'recruit') {
            filteredData = activitiesData.filter(activity =>
                activity.from === 5 || activity.from === 6 || activity.from === 9);
        } else if (filterType === 'rp') {
            filteredData = activitiesData.filter(activity => activity.from === 8);
        }

        sortActivities();
    }

    // æ’åºæ´»åŠ¨
    function sortActivities() {
        const sortBy = document.getElementById('sort-by').value;

        if (sortBy === 'newest') {
            filteredData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        } else if (sortBy === 'oldest') {
            filteredData.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        } else if (sortBy === 'popular') {
            filteredData.sort((a, b) => {
                const aLikes = parseInt(a.like_count) || 0;
                const bLikes = parseInt(b.like_count) || 0;
                return bLikes - aLikes;
            });
        }

        displayActivities();
    }

    // æ˜¾ç¤ºæ´»åŠ¨
    function displayActivities() {
        const container = document.getElementById('activity-container');

        if (filteredData.length === 0) {
            container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ´»åŠ¨</div>';
            return;
        }

        container.innerHTML = '<div class="activity-list"></div>';
        const activityList = container.querySelector('.activity-list');

        filteredData.forEach(activity => {
            const activityCard = createActivityCard(activity);
            activityList.appendChild(activityCard);
        });
    }

    // åˆ›å»ºæ´»åŠ¨å¡ç‰‡
    function createActivityCard(activity) {
        const card = document.createElement('div');
        card.className = 'activity-card';
        card.dataset.activity = JSON.stringify(activity);

        // è§£æå¾½ç« æ•°æ®
        let badges = [];
        try {
            badges = JSON.parse(activity.badge);
        } catch (e) {
            console.error('Error parsing badges:', e);
        }

        // è·å–æ´»åŠ¨ç±»å‹å’Œå†…å®¹
        const { typeText, title, content, coverImage } = getActivityDetails(activity);

        // ä½¿ç”¨ä»£ç†å¤„ç†å›¾ç‰‡URL
        const avatarUrl = activity.avatar ? getProxiedImageUrl(activity.avatar) : DEFAULT_AVATAR;
        const coverUrl = coverImage ? getProxiedImageUrl(coverImage) : null;

        card.innerHTML = `
            <div class="activity-header">
                <img src="${avatarUrl}" alt="å¤´åƒ" class="avatar" onerror="this.src='${DEFAULT_AVATAR}'">
                <div class="character-info">
                    <div class="character-name">${activity.character_name}</div>
                    <div class="server-info">${activity.area_name} Â· ${activity.group_name}</div>
                    <span class="activity-type">${typeText}</span>
                </div>
            </div>

            <div class="activity-content">
                <div class="activity-title">${title || 'æ— æ ‡é¢˜'}</div>
                <div class="activity-preview">${content}</div>
                ${coverUrl ? `<img src="${coverUrl}" class="cover-image" alt="å°é¢" onerror="this.style.display='none'">` : ''}
            </div>

            ${badges.length > 0 ? `
            <div class="badges">
                ${badges.slice(0, 3).map(badge =>
            `<span class="badge">${badge.badgeName}</span>`
        ).join('')}
                ${badges.length > 3 ? `<span class="badge">+${badges.length - 3}æ›´å¤š</span>` : ''}
            </div>
            ` : ''}

            <div class="activity-meta">
                <div>${formatDate(activity.created_at)}</div>
                <div>â¤ï¸ ${activity.like_count} Â· ğŸ’¬ ${activity.comment_count}</div>
            </div>
        `;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ‰“å¼€å¼¹çª—
        card.addEventListener('click', function() {
            openModal(activity);
        });

        return card;
    }

    // æ‰“å¼€å¼¹çª—æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
    function openModal(activity) {
        const modal = document.getElementById('detailModal');
        const modalBody = document.getElementById('modalBody');

        // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
        modalBody.innerHTML = '';

        // åˆ›å»ºè§’è‰²ä¿¡æ¯éƒ¨åˆ†
        const characterInfoSection = createCharacterInfoSection(activity);
        modalBody.appendChild(characterInfoSection);

        // åˆ›å»ºæ´»åŠ¨å†…å®¹éƒ¨åˆ†
        const contentSection = createContentSection(activity);
        modalBody.appendChild(contentSection);

        // å¦‚æœæœ‰é¢å¤–ä¿¡æ¯ï¼Œåˆ›å»ºè¯¦ç»†ä¿¡æ¯éƒ¨åˆ†
        const detailSection = createDetailSection(activity);
        if (detailSection) {
            modalBody.appendChild(detailSection);
        }

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'block';
    }

    // åˆ›å»ºè§’è‰²ä¿¡æ¯éƒ¨åˆ†
    function createCharacterInfoSection(activity) {
        const section = document.createElement('div');
        section.className = 'modal-section';

        const avatarUrl = activity.avatar ? getProxiedImageUrl(activity.avatar) : DEFAULT_AVATAR;
        const { typeText } = getActivityDetails(activity);

        section.innerHTML = `
            <div class="modal-character-info">
                <img src="${avatarUrl}" alt="å¤´åƒ" class="modal-character-avatar" onerror="this.src='${DEFAULT_AVATAR}'">
                <div class="modal-character-details">
                    <div class="modal-character-name">${activity.character_name}</div>
                    <div class="modal-character-server">${activity.area_name} Â· ${activity.group_name}</div>
                    <span class="modal-activity-type">${typeText}</span>
                </div>
            </div>
            <div class="activity-meta">
                <div>å‘å¸ƒäº ${formatFullDate(activity.created_at)}</div>
                <div>â¤ï¸ ${activity.like_count} ä¸ªèµ Â· ğŸ’¬ ${activity.comment_count} æ¡è¯„è®º</div>
            </div>
        `;

        return section;
    }

    // åˆ›å»ºå†…å®¹éƒ¨åˆ†
    function createContentSection(activity) {
        const section = document.createElement('div');
        section.className = 'modal-section';

        const { title, content, coverImage } = getActivityDetails(activity);

        // å¤„ç†HTMLå†…å®¹ä¸­çš„å›¾ç‰‡ä»£ç†å’Œæ ·å¼
        let processedContent = content;
        if (content && (content.includes('<img') || content.includes('src='))) {
            processedContent = processHtmlImages(content);
        }

        // å¤„ç†å°é¢å›¾ç‰‡
        let imagesHtml = '';
        if (coverImage) {
            const images = coverImage.split(',');
            imagesHtml = `
                <div class="modal-images">
                    ${images.map(img => `
                        <img src="${getProxiedImageUrl(img)}" class="modal-image" alt="å†…å®¹å›¾ç‰‡"
                             onerror="this.style.display='none'">
                    `).join('')}
                </div>
            `;
        }

        section.innerHTML = `
            <h3>å†…å®¹è¯¦æƒ…</h3>
            ${title ? `<div class="modal-field"><div class="modal-field-value" style="font-weight: bold; font-size: 1.2rem; margin-bottom: 10px;">${title}</div></div>` : ''}
            ${processedContent ? `<div class="modal-content-text">${processedContent}</div>` : '<div class="modal-content-text">æš‚æ— è¯¦ç»†å†…å®¹</div>'}
            ${imagesHtml}
        `;

        return section;
    }

    // åˆ›å»ºè¯¦ç»†ä¿¡æ¯éƒ¨åˆ†
    function createDetailSection(activity) {
        if (!activity.from_info) return null;

        const section = document.createElement('div');
        section.className = 'modal-section';

        let detailsHtml = '';

        // æ ¹æ®æ´»åŠ¨ç±»å‹æ˜¾ç¤ºä¸åŒçš„è¯¦ç»†ä¿¡æ¯
        switch(activity.from) {
            case 2: // å¸–å­
            case 5: // å¯¼å¸ˆæ‹›å‹Ÿ
            case 9: // å…¶ä»–æ‹›å‹Ÿ
            case 6: // å‰¯æœ¬æ‹›å‹Ÿ
                if (activity.from_info.fb_name) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">å‰¯æœ¬ï¼š${activity.from_info.fb_name}</div></div>`;
                }
                if (activity.from_info.progress) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">è¿›åº¦ï¼š${activity.from_info.progress}</div></div>`;
                }
                if (activity.from_info.fb_time) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">æ—¶é—´ï¼š${activity.from_info.fb_time}</div></div>`;
                }
                if (activity.from_info.team_composition) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">é˜Ÿä¼æ„æˆï¼š${activity.from_info.team_composition}</div></div>`;
                }
                if (activity.from_info.strategy) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">æ”»ç•¥ï¼š${activity.from_info.strategy}</div></div>`;
                }
                if (activity.from_info.labelInfo) {
                    detailsHtml += `<div class="label-container">${activity.from_info.labelInfo.map(label => `<span class="label">${label.name}</span>`).join('')}</div></div>`;
                }
                break;

            case 8: // RPæ´»åŠ¨
                if (activity.from_info.rp_name) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">æ´»åŠ¨åç§°ï¼š${activity.from_info.rp_name}</div></div>`;
                }
                if (activity.from_info.profile) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">æ´»åŠ¨ç®€ä»‹ï¼š${activity.from_info.detail_mask}</div></div>`;
                }
                if (activity.from_info.start_time) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">å¼€å§‹æ—¶é—´ï¼š${formatFullDate(activity.from_info.start_time)}</div></div>`;
                }
                if (activity.from_info.address) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">åœ°å€ï¼š${activity.from_info.address}</div></div>`;
                }
                if (activity.from_info.open_time) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">å¼€æ”¾æ—¶é—´ï¼š${activity.from_info.open_time}</div></div>`;
                }
                if (activity.from_info.custom_label) {
                    const labels = activity.from_info.custom_label.split(',');
                    detailsHtml += `<div class="label-container">${labels.map(label => `<span class="label">${label}</span>`).join('')}</div></div>`;
                }
                break;

            case 7: // åˆ†äº«æ‹›å‹Ÿ
                if (activity.from_info.guild_name) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">éƒ¨é˜Ÿï¼š${activity.from_info.guild_name}</div></div>`;
                }
                if (activity.from_info.guild_tag) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">éƒ¨é˜Ÿç®€ç§°ï¼š${activity.from_info.guild_tag}</div></div>`;
                }
                if (activity.from_info.weekend_time) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">å‘¨æœ«æ´»è·ƒæ—¶é—´ï¼š${activity.from_info.weekend_time}</div></div>`;
                }
                if (activity.from_info.weekday_time) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">å·¥ä½œæ—¥æ´»è·ƒæ—¶é—´ï¼š${activity.from_info.weekday_time}</div></div>`;
                }
                if (activity.from_info.detail_mask) {
                    detailsHtml += `<div class="modal-field"><div class="modal-field-value">è¯¦æƒ…ï¼š${activity.from_info.detail_mask}</div></div>`;
                }
                break;
        }

        // å¦‚æœæ²¡æœ‰è¯¦ç»†ä¿¡æ¯ï¼Œåˆ™ä¸æ˜¾ç¤ºæ­¤éƒ¨åˆ†
        if (!detailsHtml) return null;

        section.innerHTML = `
            <h3>æ´»åŠ¨è¯¦æƒ…</h3>
            ${detailsHtml}
        `;

        return section;
    }

    // å…³é—­å¼¹çª—
    function closeModal() {
        const modal = document.getElementById('detailModal');
        modal.style.display = 'none';
    }

    // è·å–ä»£ç†å›¾ç‰‡URL
    function getProxiedImageUrl(originalUrl) {
        // å¦‚æœå·²ç»æ˜¯ä»£ç†URLï¼Œç›´æ¥è¿”å›
        if (originalUrl.includes('weserv.nl')) {
            return originalUrl;
        }

        // ä½¿ç”¨images.weserv.nlä»£ç†æœåŠ¡
        return `${IMAGE_PROXY_URL}${encodeURIComponent(originalUrl)}`;
    }

    // å¤„ç†HTMLå†…å®¹ä¸­çš„å›¾ç‰‡ä»£ç†å’Œæ ·å¼
    function processHtmlImages(htmlContent) {
        if (!htmlContent) return htmlContent;

        // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ æ¥è§£æå’Œä¿®æ”¹HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;

        // å¤„ç†æ‰€æœ‰imgæ ‡ç­¾
        const images = tempDiv.querySelectorAll('img');
        images.forEach(img => {
            const originalSrc = img.getAttribute('src');
            if (originalSrc && !originalSrc.startsWith('data:')) { // æ’é™¤data URI
                const proxiedSrc = getProxiedImageUrl(originalSrc);
                img.setAttribute('src', proxiedSrc);

                // ç§»é™¤åŸæœ‰çš„width/heightå±æ€§ï¼Œè®©CSSæ§åˆ¶å°ºå¯¸
                img.removeAttribute('width');
                img.removeAttribute('height');

                // æ·»åŠ é”™è¯¯å¤„ç†
                img.onerror = function() {
                    console.warn('ä»£ç†å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹URL:', originalSrc);
                    this.setAttribute('src', originalSrc);

                    // å¦‚æœåŸå§‹å›¾ç‰‡ä¹ŸåŠ è½½å¤±è´¥ï¼Œéšè—å›¾ç‰‡
                    this.onerror = function() {
                        this.style.display = 'none';
                    };
                };
            }
        });

        return tempDiv.innerHTML;
    }

    // è·å–æ´»åŠ¨è¯¦æƒ…
    function getActivityDetails(activity) {
        let typeText = '';
        let title = '';
        let content = '';
        let coverImage = '';

        // æ ¹æ®fromå­—æ®µåˆ¤æ–­æ´»åŠ¨ç±»å‹
        switch(activity.from) {
            case 2: // å¸–å­
                typeText = 'å‘è¡¨äº†å¸–å­';
                if (activity.from_info) {
                    title = activity.from_info.title;
                    content = activity.from_info.content_pre || '';
                    coverImage = activity.from_info.cover_pic || '';
                }
                break;
            case 5: // å¯¼å¸ˆæ‹›å‹Ÿ
                typeText = 'å‘å¸ƒäº†å¯¼å¸ˆæ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = activity.from_info.title;
                    content = activity.from_info.detail_mask ?
                        activity.from_info.detail_mask.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : '';
                }
                break;
            case 6: // å‰¯æœ¬æ‹›å‹Ÿ
                typeText = 'å‘å¸ƒäº†å‰¯æœ¬æ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = activity.from_info.fb_name;
                    content = activity.from_info.progress || '';
                }
                break;
            case 8: // RPæ´»åŠ¨
                typeText = 'å‘å¸ƒäº†RPæ´»åŠ¨';
                if (activity.from_info) {
                    title = activity.from_info.rp_name;
                    content = activity.from_info.profile || '';
                    coverImage = activity.from_info.cover_pic || '';
                }
                break;
            case 9: // å…¶ä»–æ‹›å‹Ÿ
                typeText = 'å‘å¸ƒäº†æ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = activity.from_info.title;
                    content = activity.from_info.detail_mask ?
                        activity.from_info.detail_mask.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : '';
                }
                break;
            case 7: // åˆ†äº«æ‹›å‹Ÿ
                typeText = 'åˆ†äº«äº†æ‹›å‹Ÿ';
                if (activity.from_info) {
                    title = activity.from_info.guild_name + ' - ' + activity.from_info.guild_tag;
                    content = activity.from_info.detail_mask ?
                        activity.from_info.detail_mask.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : '';
                    coverImage = activity.from_info.cover_pic || '';
                }
                break;
            default:
                typeText = activity.mask_content || 'å‘å¸ƒäº†å†…å®¹';
        }

        // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨mask_content
        if (!content && activity.mask_content && activity.mask_content !== 'å‘è¡¨äº†å¸–å­ï¼š' &&
            activity.mask_content !== 'å‘å¸ƒäº†æ‹›å‹Ÿï¼š' && activity.mask_content !== 'å‘å¸ƒäº†RPï¼š') {
            content = activity.mask_content;
        }

        return { typeText, title, content, coverImage };
    }

    // æ ¼å¼åŒ–æ—¥æœŸï¼ˆç®€çŸ­ï¼‰
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 60) {
            return `${diffMins}åˆ†é’Ÿå‰`;
        } else if (diffHours < 24) {
            return `${diffHours}å°æ—¶å‰`;
        } else if (diffDays < 7) {
            return `${diffDays}å¤©å‰`;
        } else {
            return date.toLocaleDateString('zh-CN');
        }
    }

    // æ ¼å¼åŒ–å®Œæ•´æ—¥æœŸ
    function formatFullDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>
</body>
</html>